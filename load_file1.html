<!DOCTYPE html>
<html>
<head>
<title>node mapping configuration</title>
</head>
<body>
<form id='process_yaml_id' name='process_yaml' enctype='multipart/form-data' method='post'>
  <fieldset>
    <h2>YAML file exercise</h2>
    <input type='file' id='fileinput'>
    <input type='button' id='btnLoad' value='Load' onclick='loadFile();'>
  </fieldset>
  <fieldset>
    <select name='select_roles' id='select_roles_id' size='1'>
      <option value='service-discovery-server-0'>consul role</option>
    </select>
    <select name='select_environments' id='select_environments_id' size='1'>
      <option value='cert'>environment</option>
    </select>
    <select name='select_datacenters' id='select_datacenters_id' size='1'>
      <option value='cert'>data center</option>
    </select>
    <input type='button' id='btnProcess' value='Find' onclick='extractId();'>
  </fieldset>
</form>
<div id='errors'></div>
<script type='text/javascript' src='js-yaml.min.js'></script>
<script type='text/javascript' src='config.js'></script>
<script type='text/javascript'>
function loadFile() {
  var input, file, fr;
  // Check for the various File API support
  if (window.File && window.FileReader && window.FileList && window.Blob) {
    // nop
  } else {
    alert('The File APIs are not fully supported in this browser.');
    return;
  }
  input = document.getElementById('fileinput');
  if (!input) {
    alert("Um, couldn't find the fileinput element.");
  } else if (!input.files) {
    alert("This browser doesn't seem to support the `files` property of file inputs.");
  } else if (!input.files[0]) {
    alert("Please select a file before clicking 'Load'");
  } else {


    fileName = input.files[0];
    try {
      console.log(fileName);
    } catch (e) {}
    fr = new FileReader();
    fr.onload = receivedText;
    fr.readAsText(fileName);
    try {
      configFile = './config.json';
      loadJSON(configFile, function(response) {
        // Parse JSON string into object
        var config_obj = JSON.parse(response);
        console.log('Loaded: ' + config_obj.toString());
        // TODO: nesting ?
      });

    } catch (e) {
      // cross origin requests are only supported
      // for protocol schemes: http, data, chrome, chrome-extension, https.
      console.log('Exception (ignored): ' + e.toString());
    }

  }

  function loadJSON(sourceFile, callback) {

    console.log('Loading: ' + sourceFile);
    try {
      var xobj = new XMLHttpRequest();
      xobj.overrideMimeType('application/json');
      xobj.open('GET', sourceFile, true);
    } catch (e) {
      console.log('Exception (ignored): ' + e.toString());
      xobj = undefined
    }
    if (xobj != undefined) {
      xobj.onreadystatechange = function() {
        if (xobj.readyState == 4 && xobj.status == '200') {
          callback(xobj.responseText);
        }
      };
      try {
        xobj.send(null);
      } catch (e) {
        // can not intercept the error
        // cross origin requests are only supported
        // for protocol schemes: http, data, chrome, chrome-extension, https.
        console.log('Exception (ignored): ' + e.toString());
      }
    }
  }

  function processConfig() {
    let lines = e.target.result;

  }

  function receivedText(e) {
    let lines = e.target.result;
    var yamlDoc = jsyaml.load(lines);
    nodes = {};
    // TODO: port, protocol, path building for healthcheck
    for (nodeName in yamlDoc) {
      // if (yamlDoc[nodeName]['consul_node_name'] != undefined) {
      // TODO: 'true JS way' does not appear to work right
      // if (!('consul_node_name' in yamlDoc[nodeName])){
      //
      if (yamlDoc[nodeName].hasOwnProperty('consul_node_name')) {
        load_data = true
      } else {
        load_data = false
      }
      if (load_data) {
        // console.log(nodeName);
        nodes[nodeName] = {
          'datacenter': yamlDoc[nodeName]['datacenter'],
          'consul_node_name': yamlDoc[nodeName]['consul_node_name'],
          'environment': yamlDoc[nodeName]['branch_name'],
          'hostname': nodeName,
        };

      }
    }
    try {
      // console.log('Nodes: ' + Object.keys(nodes).join(',').substring(0, 60) + '\nSample drilldown: ' + nodes[Object.keys(nodes)[0]]['consul_node_name']);
      document.process_yaml.select_roles.options.length = 0;
      select_roles = {}
      let cnt = 0;
      for (var node_name in nodes) {
        // console.log('processed node: ' + node_name ) ;
        let consul_role = nodes[node_name]['consul_node_name'];
        // console.log('loaded: ' + consul_role ) ;
        select_roles[consul_role] = 1;
      }
      for (var consul_role in select_roles) {
        document.process_yaml.select_roles.options[cnt] = new Option(consul_role, consul_role, false, false);
        cnt++
      }
      document.process_yaml.select_environments.options.length = 0;
      select_environments = {}
      cnt = 0;
      let branch_names = config_data['branch_names'];
      /*
      branch_names = {
        'test': 'TEST',
        'test_wec': 'TEST',
        'prod': 'PROD',
        'prod_bcp': 'PROD',
        'sandbox': 'SANDBOX',
        'cert': 'VALIDATION',
        'cert_bcp': 'VALIDATION',
      };
*/
      for (var node_name in nodes) {
        console.log('processed node: ' + node_name);
        let environment = nodes[node_name]['environment'];
        console.log('loaded: ' + environment);
        select_environments[environment] = branch_names.hasOwnProperty(environment) ? branch_names[environment] : environment;
      }
      branch_selects = {}

      for (var environment in select_environments) {
        let environment_displayname = select_environments[environment]
        if (branch_selects.hasOwnProperty(environment_displayname)) {
          select_environments[environment] = '';
          console.log('will ignore: ' + environment + '(' + environment_displayname + ') ');
        }
        branch_selects[environment_displayname] = 1;
      }

      for (var environment in select_environments) {
        // NOTE: not Object.keys->() or will get 0,1,...
        if (!(branch_names.hasOwnProperty(environment)) || select_environments[environment] != "") {
          document.process_yaml.select_environments.options[cnt] = new Option(branch_names.hasOwnProperty(environment) ? branch_names[environment] : environment, environment, false, false);
          cnt++
        }
      }
      document.process_yaml.select_datacenters.options.length = 0;
      select_datacenters = {}

      for (var node_name in nodes) {
        // console.log('processed node: ' + node_name ) ;
        let datacenter = nodes[node_name]['datacenter'];
        // console.log('loaded: ' + datacenter ) ;
        select_datacenters[datacenter] = 1;
      }
      let datacenter_names = config_data['datacenter_names'];
      /*
      datacenter_names = {
        'wec': 'WEC',
        'wec1': 'WEC',
        'oxdc': 'OXMOOR',
        'st_louis': 'ST LOUIS',
        'sv': 'SHOREVIEW',
      };
      */
      cnt = 0;
      for (var datacenter in select_datacenters) { // NOTE: not Object.keys->() or will get 0,1,...
        console.log('adding option: ' + datacenter);
        document.process_yaml.select_datacenters.options[cnt] = new Option(datacenter_names[datacenter], datacenter, false, false);
        cnt++
      }
    } catch (e) {
      document.getElementById('errors').innerHTML = e.message;
    }
    localStorage.setItem('nodes', JSON.stringify(nodes));
  }
}

function extractId() {
  let nodes = JSON.parse(localStorage.getItem('nodes'));
  let select_roles = document.getElementById("select_roles_id");
  var select_role_value = select_roles.options[select_roles.selectedIndex].value;
  var select_role_text = select_roles.options[select_roles.selectedIndex].text;

  let select_environments = document.getElementById("select_environments_id");
  var select_environment_value = select_environments.options[select_environments.selectedIndex].value;
  var select_environment_text = select_environments.options[select_environments.selectedIndex].text;

  let select_datacenters = document.getElementById("select_datacenters_id");
  var select_datacenter_value = select_datacenters.options[select_datacenters.selectedIndex].value;
  var select_datacenter_text = select_datacenters.options[select_datacenters.selectedIndex].text;

  select_nodes = {};
  for (var node_name in nodes) {
    var node_obj = nodes[node_name];
    let node_consul_role = node_obj['consul_node_name'];
    let node_environment = node_obj['environment'];
    let node_datacenter = node_obj['datacenter'];
    console.log('comparing: ' + node_consul_role);
    if (node_datacenter == select_datacenter_value && node_consul_role == select_role_value) {
      if (node_environment.indexOf(select_environment_value) == 0) {
        select_nodes[node_name] = 1;
      }
    }
  }
  if (Object.keys(select_nodes).length > 0) {
    alert('Role: ' + select_role_value + '\n' + 'Data center: ' + select_datacenter_value + '\n' + 'Environment: ' + select_environment_value + '\n' + 'Node(s): ' + Object.keys(select_nodes).join(',').substring(0, 60));
  } else {
    alert('Role: ' + select_role_value + '\n' + 'Data center: ' + select_datacenter_value + '\n' + 'Environment: ' + select_environment_value + '\n' + 'has no matching node');
  }
}
</script>
</body>
</html>
